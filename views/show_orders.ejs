<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Booksaw.co</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Amita:wght@400;700&family=Young+Serif&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Libre+Barcode+128&display=swap"
      rel="stylesheet"
    />

    <script
      type="module"
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"
    ></script>
    <script
      nomodule
      src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"
    ></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Mallanna&family=Libre+Caslon+Text:ital,wght@0,400;0,700;1,400&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&family=Rubik:wght@500&&family=Water+Brush&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@200..900&family=VT323&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=VT323&display=swap"
      rel="stylesheet"
    />

    <script defer src="/js/cate_popup.js"></script>
    <script defer src="/js/add_to_cart.js"></script>
    <script defer src="/js/copy.js"></script>

    <link rel="stylesheet" href="/css/index.css" />
    <link rel="stylesheet" href="/css/show_order.css" />
  </head>
  <body>
    <!-- Header Section -->
    <%- include('partials/header') %>

    <section class="Show-orders_section">
      <div class="Show-orders_container">
        <div class="text_section">
          <h1 class="h1_txt">Order History</h1>
          <p>Check the status of recent orders and manage products.</p>
        </div>

        <% if (orders && orders.length > 0) { %> <% orders.forEach(order => { %>
        <div class="order-group">
          <div class="rp_flex_box">
            <div class="order_date">
              <% const dateObj = new Date(order.order_date); const dateString =
              dateObj.toLocaleString("en-IN", { day: "numeric", month: "long",
              year: "numeric", hour: "numeric", minute: "2-digit", timeZone:
              "Asia/Kolkata" }); %>
              <p class="date"><%= dateString %></p>
              <p class="total_amt">
                Order Total:
                <strong>â‚¹<%= Number(order.total_amount).toFixed(2) %></strong>
              </p>
            </div>
            <!-- receipt button -->
            <ion-icon
              class="icon_receipt receipt_icon"
              name="receipt-outline"
              onclick="openReceipt('<%= order.order_id %>')"
            >
            </ion-icon>
          </div>

          <% if (order.items && order.items.length > 0) { %> <%
          order.items.forEach(item => { %>
          <div class="item_con">
            <div class="cart_item--box">
              <div class="img_box">
                <img
                  class="img"
                  src="/images/book_img/<%= item.file_name %>"
                  alt="<%= item.book_name %>"
                />
              </div>
              <div class="C_box_txt">
                <h4><%= item.book_name %></h4>
                <span><%= item.author %></span>
                <span class="cate"><%= item.cate %></span>
              </div>
              <div>
                <span>x <%= item.quantity %></span>
              </div>
              <div>
                <span class="status <%= item.status %>"
                  ><%= item.status %></span
                >
              </div>
              <span><%= new Date(order.delivery_date).toDateString() %></span>
              <div class="tol_price">
                <span class="price"
                  >â‚¹ <%= Number(item.price).toFixed(2) %></span
                >
              </div>
              <% if(item.status !== 'delivered' && item.status !== 'Cancelled'){
              %>
              <div class="cancel-order">
                <a
                  style="text-decoration: none; color: inherit"
                  href="/cancel_order?orderItemId=<%= item.id %>"
                  >Cancel Order</a
                >
              </div>
              <% };%>
            </div>
          </div>
          <% }) %> <% } else { %>
          <p>No items found for this order.</p>
          <% } %>
        </div>

        <!-- ðŸ”¹ Receipt Popup for this order -->
        <div id="printableArea-<%= order.order_id %>" class="receipt hidden">
          <div class="rp_flex_box top_box">
            <h2>Order Receipt</h2>
            <div style="display: flex; align-items: center; gap: 2rem">
              <ion-icon
                class="icon_print print"
                onclick="printDiv('printableArea-<%= order.order_id %>')"
                name="print-outline"
              >
              </ion-icon>
              <ion-icon
                style="font-size: 2.9rem"
                class="icon_close"
                name="close-outline"
                onclick="closeReceipt('<%= order.order_id %>')"
              >
              </ion-icon>
            </div>
          </div>

          <div class="rp_flex_box">
            <img class="receipt_logo" src="/images/main-logo.png" alt="logo" />
            <h1 class="comp">Booksaw.co</h1>
          </div>

          <!-- delivery & items (your current receipt template) -->
          <div class="delivery_timing">
            <div>
              <% const date_Obj = new Date(order.order_date); const day = ('0' +
              date_Obj.getDate()).slice(-2); const month = ('0' +
              (date_Obj.getMonth() + 1)).slice(-2); const year =
              date_Obj.getFullYear(); let hours = date_Obj.getHours(); const
              minutes = date_Obj.getMinutes(); const seconds =
              date_Obj.getSeconds(); const ampm = hours >= 12 ? 'P.M.' : 'A.M.';
              hours = hours % 12 || 12; const formattedMinutes =
              minutes.toString().padStart(2, '0'); const formattedSeconds =
              seconds.toString().padStart(2, '0'); const timeString =
              `${hours}:${formattedMinutes}:${formattedSeconds} ${ampm}`; %>
              <p><%= day %>/<%= month %>/<%= year %></p>
              <p style="font-style: normal" class="main"><%= timeString %></p>

              <!-- delivery address -->
              <p><%= order.address %></p>
              <p><%= order.city %></p>
              <p><%= order.state %> <%= order.pin %></p>
              <p><%= order.country %></p>
            </div>

            <div>
              <% if (order.delivery_date) { const DateObj = new
              Date(order.delivery_date); const Day = ('0' +
              DateObj.getDate()).slice(-2); const Month = ('0' +
              (DateObj.getMonth() + 1)).slice(-2); const Year =
              DateObj.getFullYear(); %>
              <p>
                Delivery Date: <span><%= Day %>.<%= Month %>.<%= Year %></span>
              </p>

              <% } %>

              <p><%= order.u_name %></p>
              <p><%= order.user_email %></p>
              <p>Teles. <%= order.u_mobileNo %></p>
            </div>
          </div>
          <div class="products_detail">
            <div class="product_list">
              <span>Product</span>
              <span>Count</span>
              <span>Price</span>
            </div>
            <% order.items.forEach(item => { %>
            <div class="product_item">
              <p><%= item.book_name %></p>
              <p><%= item.quantity %></p>
              <p><%= item.price %></p>
            </div>
            <% }); %>
          </div>
          <div class="total_box">
            <div>
              <p>Subtotal</p>
              <p>Shipping</p>
            </div>
            <div>
              <p><%= order.total_amount %></p>
              <p>Free</p>
            </div>
          </div>

          <div class="total_detail">
            <div class="flex_div">
              <p>Total</p>
              <p><%= order.total_amount %></p>
            </div>
          </div>
          <div
            style="
              display: grid;
              justify-content: center;
              text-align: center;
              gap: 1rem;
              margin-top: 2rem;
            "
          >
            <p style="font-size: 1.5rem">Thank you for Shopping!</p>
            <p class="barcode">BOOKSAW one booksaw one BOOKSAW</p>
          </div>
        </div>
        <!-- end of receipt -->
        <% }) %> <% } else { %>
        <p
          style="
            display: flex;
            place-content: center;
            justify-items: center;
            gap: 1rem;
            margin-top: 2rem;
            font-size: 1.5rem;
            font-weight: 600;
          "
        >
          You haven't placed any orders yet.
        </p>
        <% } %>
      </div>
    </section>

    <!-- Background -->
    <div class="shadow_bg hidden"></div>

    <!-- Footer -->
    <%- include('partials/footer') %>
  </body>
  <script>
    // show receipt overlay + shadow background
    function openReceipt(orderId) {
      const el = document.getElementById(`printableArea-${orderId}`);
      const shadow = document.querySelector('.shadow_bg');

      if (!el) return;
      el.classList.remove('hidden');
      if (shadow) shadow.classList.add('visible');
      // prevent background scroll
      document.documentElement.style.overflow = 'hidden';
      document.body.style.overflow = 'hidden';
    }

    // close specific receipt
    function closeReceipt(orderId) {
      const el = document.getElementById(`printableArea-${orderId}`);
      const shadow = document.querySelector('.shadow_bg');

      if (!el) return;
      el.classList.add('hidden');
      if (shadow) shadow.classList.remove('visible');
      document.documentElement.style.overflow = '';
      document.body.style.overflow = '';
    }

    // print only the receipt contents
    function printDiv(id) {
      const printEl = document.getElementById(id);
      if (!printEl) return;

      // hide other things
      const originalTitle = document.title;
      const restore = [];

      // Create new window for printing for consistent results
      const w = window.open('', '_blank', 'noopener,noreferrer');
      if (!w) {
        // fallback: use print area approach
        window.print();
        return;
      }

      const doc = w.document;
      // Basic styles (you can insert custom print CSS here)
      doc.write('<!doctype html><html><head><title>Receipt</title>');
      doc.write(
        '<meta name="viewport" content="width=device-width,initial-scale=1" />'
      );
      doc.write('<style>');
      doc.write('body{font-family: monospace; padding:20px; color:#111} ');
      doc.write(
        '.product_list, .product_item{display:grid; grid-template-columns:1fr 6rem 6rem; gap:0.5rem;}'
      );
      doc.write(
        '.barcode{font-family: "Libre Barcode 128", monospace; font-size:28px;}'
      );
      doc.write('</style></head><body>');
      doc.write(printEl.innerHTML);
      doc.write('</body></html>');
      doc.close();
      w.focus();
      setTimeout(() => {
        w.print();
        w.close();
      }, 300);
    }
  </script>
</html>
